<!DOCTYPE html>
<html âš¡="">
  <head>
    <!-- The AMP boilerplate.-->
    <meta charset="utf-8">
    <script async="" src="https://cdn.ampproject.org/v0.js"></script>
    <meta name="viewport" content="width=device-width,minimum-scale=1,initial-scale=1">
    <style amp-boilerplate="">body{-webkit-animation:-amp-start 8s steps(1,end) 0s 1 normal both;-moz-animation:-amp-start 8s steps(1,end) 0s 1 normal both;-ms-animation:-amp-start 8s steps(1,end) 0s 1 normal both;animation:-amp-start 8s steps(1,end) 0s 1 normal both}@-webkit-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-moz-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-ms-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-o-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}</style>
    <noscript>
      <style amp-boilerplate="">body{-webkit-animation:none;-moz-animation:none;-ms-animation:none;animation:none}</style>
    </noscript>
    <!--end AMP-->
    <link rel="canonical" href="/post/mserv/">
  </head>
  <body><h1 id="fetch-and-middleware-api-microservices">Fetch and Middleware API/MicroServices</h1>
<p>Here we will fetch() and use a middleware API. Fetch() is the new js API that replaces Ajax/XHR. For older browsers it has a polyfill listed on CanIUse.com.</p>
<h2 id="0-warm-up-deploy-to-cloud-">0. (Warm up) Deploy to cloud.</h2>
<p>Running your own back end or database software is not a good practice. There are many back end providers for Node+Express and database api: Firebase, Backendless, AWS and Google Cloud. You choice may depends on what back end you will need, as each cloud has a different back end offering. For example, do you like GAE BigQuery/DataStore or AWS Simple DB offerings. You can use any cloud/BaaS that you like, but avoid hosting your own servers, ex: Mongo in the cloud - where you have to scale or secure it. Much better to Bass</p>
<p>Here are some docs on Google Cloud:</p>
<ul>
<li><a href="http://cloud.google.com/appengine/docs/flexible/nodejs">http://cloud.google.com/appengine/docs/flexible/nodejs</a></li>
<li><p><a href="https://github.com/GoogleCloudPlatform/google-cloud-node">https://github.com/GoogleCloudPlatform/google-cloud-node</a></p>
<pre><code>  gcloud init 
  gcloud app deploy -v 1
</code></pre></li>
</ul>
<p>Once you know how to deploy &quot;Hello World&quot; express to (Google) cloud, go to the next step. We will next deploy our micro service to the cloud.</p>
<h2 id="1-view-the-source-of-this-page-and-click-the-button-this-will-help-you-review-how-to-fetch-from-a-browser-against-a-working-service-so-you-know-any-error-is-not-on-client-side-">1. View the source of this page, and click the button. This will help you review how to fetch() from a browser - against a working service. So you know any error is not on client side.</h2>
<pre><code>    function tstGet() {
        fetch(&#39;https://rch-demo.appspot.com/membersPg/mem/&#39;, { //1 call
                method: &#39;get&#39;
            }).then(function(response) { //2 promise
                return (response.json())
                }).then(function(value) { //3
                    // your code here
                    console.log(&#39;back&#39;)
                    console.log(JSON.stringify(value))
            }).catch(function(err) {
                console.log(&#39;error&#39;)
                console.log(err)
        })//fetch()
    }//()
</code></pre><p>Run this code in a browser, on a button clicked event to <em>fetch</em> some data. Optionally, test, ex: QUnit. </p>
<h2 id="2-lets-deploy-our-microservice-">2. Lets deploy our microservice.</h2>
<p>Download and expand: <a href="https://www.masons-foundation.org/zCDN/mserv.zip">https://www.masons-foundation.org/zCDN/mserv.zip</a></p>
<p>Deploy this code as node service to your (Google) cloud. Test, ex: QUnit.</p>
<p>If you are not able to get above microservice to work, go to next step anyway.</p>
<h3 id="3-lets-do-a-code-review-of-the-microservice-">3. Lets do a code review of the microservice.</h3>
<p>We recommend that the routes match url on the front end. So if you are calling the microservice from /home/member then the route in express should be /home/member + a descriptive name of the function. Some REST zelots name routes based on back end entities. We believe it&#39;s a better practice to mirror the front end instead. The microservice will deal with entities as needed and shield the implementation away from the front end reqs. The sample and the index.js looks like this:</p>
<pre><code>    const middle = express()
    const membersPg = require(&#39;./front_routes/membersPg&#39;)
    const cfenv = require(&#39;cfenv&#39;)

    //set up filters chain ###################### 
    middle.use(bodyParser.json()) // parse application/json
    middle.use(cors())
    //routes ###################### 
    middle.use(&#39;/membersPg&#39;, membersPg) //front route 1 - match the front end

    // get the app environment from Cloud Foundry
    var appEnv = cfenv.getAppEnv();
    // start server on the specified port and binding host
    middle.listen(appEnv.port, &#39;0.0.0.0&#39;, function() {
        console.log(&quot;server starting on &quot; + appEnv.url)
    })
</code></pre><p>And the route:</p>
<pre><code>    const router = express.Router()
    const fake = require(&#39;./fake&#39;)

    router.all(&#39;/mem&#39;, function (req, res) {
        var ret = fake._fakeBind()
        res.status(200).send(JSON.stringify(ret))
    })
    module.exports = router
</code></pre><p>If there is an error, return status that is not 200. 
And our back end:</p>
<pre><code>    exports._fakeBind = function() {
        let _people = {people: [{name: &#39;Jim&#39;}, {name: &#39;Pedro&#39;}] }
        return _people
    }
</code></pre><p>We fake a DB for now (vs using Google Cloud DataStore). And of course you can add other middleware, like GZIP and setup JWT.</p>
<h3 id="4-full-stack">4. Full stack</h3>
<p>Middleware also includes data binding for the front end team, such us jsRender, <a href="http://github.com/corinis/jsForm">http://github.com/corinis/jsForm</a>, datatables.net.</p>

    <p>Footer A</p>
  </body>
</html>